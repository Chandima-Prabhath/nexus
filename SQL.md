```sql
-- SQL Script for Supabase Database Setup for Nexus File Hosting

-- 1. Create the 'hosted_files' table
-- This table will store metadata about the files uploaded via the Telegram bot.

CREATE TABLE IF NOT EXISTS public.hosted_files (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    file_id TEXT NOT NULL UNIQUE,                       -- Telegram's unique file_id
    unique_token TEXT NOT NULL UNIQUE,                  -- Our unique token for the shareable link
    original_filename TEXT,                             -- Original filename of the uploaded file
    uploader_id BIGINT NOT NULL,                        -- Telegram User ID of the admin who uploaded
    uploaded_at TIMESTAMPTZ DEFAULT NOW() NOT NULL      -- Timestamp of when the record was created
);

-- 2. Add comments to the table and columns for clarity (Optional)
COMMENT ON TABLE public.hosted_files IS 'Stores metadata for files hosted via the Telegram bot.';
COMMENT ON COLUMN public.hosted_files.id IS 'Auto-incrementing primary key.';
COMMENT ON COLUMN public.hosted_files.file_id IS 'Telegram''s unique file identifier. Must be unique in this table.';
COMMENT ON COLUMN public.hosted_files.unique_token IS 'Unique token generated for the shareable link. Must be unique.';
COMMENT ON COLUMN public.hosted_files.original_filename IS 'The original filename of the file as uploaded to Telegram.';
COMMENT ON COLUMN public.hosted_files.uploader_id IS 'The Telegram User ID of the admin who uploaded/forwarded the file.';
COMMENT ON COLUMN public.hosted_files.uploaded_at IS 'Timestamp indicating when the file record was created in the database.';

-- 3. Row Level Security (RLS) - IMPORTANT for production
-- Enable RLS on the table.
ALTER TABLE public.hosted_files ENABLE ROW LEVEL SECURITY;

-- Example RLS Policies:
-- These are basic examples. You'll need to tailor them to your exact security requirements.
-- If your SUPABASE_KEY is a service_role key, it bypasses RLS by default.
-- If you are using an anon key for backend operations, you MUST define appropriate policies.

-- OPTION A: If using service_role key from backend (simplest for this project, but service_role key is powerful)
-- If your backend (Python scripts) uses the `service_role` key, it will bypass RLS.
-- No specific RLS policies might be needed for the backend to function, but this means any
-- frontend access using the `anon` key would be denied by default unless policies are added.

-- OPTION B: If using anon key from backend and want to grant broad access (less secure for public tables)
-- This is generally NOT recommended for tables with sensitive or user-specific data without more specific checks.
-- For this specific application, since it's admin-focused from the backend:
-- Policy to allow all operations for authenticated users (if you were to use Supabase Auth for dashboard users)
-- CREATE POLICY "Allow all for authenticated users" ON public.hosted_files
-- FOR ALL
-- TO authenticated
-- USING (true)
-- WITH CHECK (true);

-- Policy to allow anon key (used by your Python backend with supabase-py) to do everything.
-- This is effectively disabling RLS for the anon key on this table.
-- Be cautious with this approach.
-- CREATE POLICY "Allow anon key full access" ON public.hosted_files
-- FOR ALL
-- TO anon
-- USING (true)
-- WITH CHECK (true);

-- A more restrictive (and better) approach if using anon key from backend:
-- Assuming your backend identifies itself or you have a specific role for it.
-- For this project, since the Python backend is the sole interactor with these policies,
-- and it's already admin-gated by Telegram User ID and dashboard passcode,
-- allowing the 'anon' role (which `supabase-py` uses by default with the anon key)
-- to perform necessary actions on this specific table is a common pattern.

-- Allow read access to all (if you want links to be resolvable by anyone with the link, which they are via the bot)
-- The bot itself handles the file serving, not direct DB access from public.
-- So, for the backend's `anon` key:
CREATE POLICY "Allow backend full access for anon key"
ON public.hosted_files
FOR ALL
TO anon -- 'anon' is the default role for the anon key
USING (true)
WITH CHECK (true);

-- If you want public read-only access (e.g., for a public API, not directly used here but for illustration)
-- CREATE POLICY "Allow public read access" ON public.hosted_files
-- FOR SELECT
-- TO public  -- or anon
-- USING (true);


-- Ensure you understand the implications of your RLS policies.
-- For this project, the Python backend (bot and dashboard) will interact with Supabase.
-- If using the `anon` key, the "Allow backend full access for anon key" policy is a pragmatic start.
-- If using the `service_role` key, RLS is bypassed by that key.

-- 4. Indexes (Optional but recommended for performance on queried columns)
-- Supabase automatically creates an index on the primary key `id`.
-- `file_id` and `unique_token` are already unique, which implies an index.
-- You might consider an index on `uploader_id` or `original_filename` if you query by them often.
-- CREATE INDEX IF NOT EXISTS idx_hosted_files_original_filename ON public.hosted_files (original_filename);
-- CREATE INDEX IF NOT EXISTS idx_hosted_files_uploader_id ON public.hosted_files (uploader_id);

-- After running these scripts, your 'hosted_files' table should be ready.
-- Remember to replace 'public' with your actual schema if you are not using the default public schema.
```

**Explanation and How to Use:**

1.  **Connect to your Supabase Project:**
    *   Go to your Supabase Dashboard.
    *   Select your project.
    *   Navigate to the "SQL Editor" section.
2.  **Run the Script:**
    *   Click on "+ New query".
    *   Copy the entire SQL script above and paste it into the SQL editor.
    *   Click "RUN".
3.  **Key Parts of the Script:**
    *   **`CREATE TABLE IF NOT EXISTS public.hosted_files`**: This creates the main table.
        *   `id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY`: Standard auto-incrementing primary key.
        *   `file_id TEXT NOT NULL UNIQUE`: Stores Telegram's file ID. `UNIQUE` ensures no duplicate Telegram files are referenced.
        *   `unique_token TEXT NOT NULL UNIQUE`: Stores our generated token for links. `UNIQUE` ensures no token collision.
        *   `original_filename TEXT`: The name of the file.
        *   `uploader_id BIGINT NOT NULL`: The Telegram user ID of the admin.
        *   `uploaded_at TIMESTAMPTZ DEFAULT NOW() NOT NULL`: Automatically records when the entry was created. `TIMESTAMPTZ` is timestamp with timezone.
    *   **`COMMENT ON ...`**: These are optional but good for documenting your schema.
    *   **Row Level Security (RLS)**:
        *   `ALTER TABLE public.hosted_files ENABLE ROW LEVEL SECURITY;`: This is crucial. By default, new tables have RLS disabled, meaning even the `anon` key can do anything. Enabling RLS means no access is allowed until policies are defined.
        *   The example policy `CREATE POLICY "Allow backend full access for anon key" ... TO anon ...` is provided. If your Python backend uses the `anon` key (from your Supabase project settings), this policy will allow it to perform all operations (SELECT, INSERT, UPDATE, DELETE) on the `hosted_files` table. **This is a common setup when the backend itself is trusted and handles its own application-level authorization.**
        *   If you use the `service_role` key for `SUPABASE_KEY` in your `.env`, that key bypasses RLS, so you might not strictly need this policy for the backend to work, but it's good practice to enable RLS and define policies anyway, especially if the `anon` key might be used elsewhere or by a frontend in the future.
    *   **Indexes**: The script mentions optional indexes. Unique constraints (on `file_id` and `unique_token`) automatically create indexes. You might add others if specific query patterns demand it.
4.  **Schema Name (`public`)**: The script assumes you are using the default `public` schema in PostgreSQL (which Supabase uses). If you use a different schema, you'll need to adjust `public.hosted_files` accordingly.

This script should set up the necessary table structure and basic security for the application to work with Supabase. Remember to configure your `.env` file with the correct `SUPABASE_URL` and `SUPABASE_KEY`.
